-- 依赖执行顺序：先表结构后触发器/存储过程/数据。
-- 重复执行友好，包含必要的 DROP 语句。

-- 1. 清理旧表（按外键依赖由子到父）
DROP TABLE IF EXISTS TB_WAITLIST;
DROP TABLE IF EXISTS TB_COURSE_TIME;
DROP TABLE IF EXISTS TB_STUDENT_COURSE;
DROP TABLE IF EXISTS TB_COURSE;
DROP TABLE IF EXISTS TB_STUDENT;
DROP TABLE IF EXISTS TB_TEACHER;
DROP TABLE IF EXISTS TB_MAJOR;
DROP TABLE IF EXISTS TB_DEPARTMENT;
DROP TABLE IF EXISTS TB_USER;
DROP TABLE IF EXISTS TB_SYS_PARAM;

-- 2. 用户表
CREATE TABLE TB_USER (
    USER_ID      INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    USERNAME     VARCHAR(50)  NOT NULL,
    PASSWORD_HASH TEXT        NOT NULL,
    PASSWORD_UPDATED_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    REAL_NAME    VARCHAR(50),
    ROLE         VARCHAR(20)  NOT NULL,
    STATUS       CHAR(1)      NOT NULL DEFAULT '1',
    EMAIL        VARCHAR(100),
    MOBILE       VARCHAR(20),
    CREATE_TIME  TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT UQ_USER_USERNAME UNIQUE (USERNAME),
    CONSTRAINT CK_USER_ROLE CHECK (ROLE IN ('ADMIN','TEACHER','STUDENT')),
    CONSTRAINT CK_USER_STATUS CHECK (STATUS IN ('1','0')),
    CONSTRAINT CK_USER_PASSWORD_HASH CHECK (LENGTH(PASSWORD_HASH) > 0)
);

-- 3. 学院表
CREATE TABLE TB_DEPARTMENT (
    DEPT_ID    INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    DEPT_CODE  VARCHAR(20)  NOT NULL,
    DEPT_NAME  VARCHAR(100) NOT NULL,
    STATUS     CHAR(1)      NOT NULL DEFAULT '1',
    CONSTRAINT UQ_DEPT_CODE UNIQUE (DEPT_CODE),
    CONSTRAINT CK_DEPT_STATUS CHECK (STATUS IN ('1','0'))
);

-- 4. 专业表
CREATE TABLE TB_MAJOR (
    MAJOR_ID    INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MAJOR_CODE  VARCHAR(20)  NOT NULL,
    MAJOR_NAME  VARCHAR(100) NOT NULL,
    DEPT_ID     INT          NOT NULL,
    STATUS      CHAR(1)      NOT NULL DEFAULT '1',
    CONSTRAINT UQ_MAJOR_CODE UNIQUE (MAJOR_CODE),
    CONSTRAINT FK_MAJOR_DEPT FOREIGN KEY (DEPT_ID) REFERENCES TB_DEPARTMENT(DEPT_ID),
    CONSTRAINT CK_MAJOR_STATUS CHECK (STATUS IN ('1','0'))
);

-- 5. 学生表
CREATE TABLE TB_STUDENT (
    STU_ID     INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    STU_NO     VARCHAR(20)  NOT NULL,
    STU_NAME   VARCHAR(50)  NOT NULL,
    GENDER     CHAR(1),
    BIRTHDAY   DATE,
    DEPT_ID    INT          NOT NULL,
    MAJOR_ID   INT          NOT NULL,
    GRADE      VARCHAR(10),
    MOBILE     VARCHAR(20),
    EMAIL      VARCHAR(100),
    USER_ID    INT          NOT NULL,
    STATUS     CHAR(1)      NOT NULL DEFAULT '1',
    CONSTRAINT UQ_STUDENT_NO UNIQUE (STU_NO),
    CONSTRAINT UQ_STUDENT_USER UNIQUE (USER_ID),
    CONSTRAINT FK_STUDENT_DEPT FOREIGN KEY (DEPT_ID) REFERENCES TB_DEPARTMENT(DEPT_ID),
    CONSTRAINT FK_STUDENT_MAJOR FOREIGN KEY (MAJOR_ID) REFERENCES TB_MAJOR(MAJOR_ID),
    CONSTRAINT FK_STUDENT_USER FOREIGN KEY (USER_ID) REFERENCES TB_USER(USER_ID),
    CONSTRAINT CK_STUDENT_GENDER CHECK (GENDER IN ('M','F')),
    CONSTRAINT CK_STUDENT_STATUS CHECK (STATUS IN ('1','0'))
);

-- 6. 教师表
CREATE TABLE TB_TEACHER (
    TEA_ID    INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    TEA_NO    VARCHAR(20)  NOT NULL,
    TEA_NAME  VARCHAR(50)  NOT NULL,
    GENDER    CHAR(1),
    TITLE     VARCHAR(50),
    DEPT_ID   INT          NOT NULL,
    MOBILE    VARCHAR(20),
    EMAIL     VARCHAR(100),
    USER_ID   INT          NOT NULL,
    STATUS    CHAR(1)      NOT NULL DEFAULT '1',
    CONSTRAINT UQ_TEACHER_NO UNIQUE (TEA_NO),
    CONSTRAINT UQ_TEACHER_USER UNIQUE (USER_ID),
    CONSTRAINT FK_TEACHER_DEPT FOREIGN KEY (DEPT_ID) REFERENCES TB_DEPARTMENT(DEPT_ID),
    CONSTRAINT FK_TEACHER_USER FOREIGN KEY (USER_ID) REFERENCES TB_USER(USER_ID),
    CONSTRAINT CK_TEACHER_GENDER CHECK (GENDER IN ('M','F')),
    CONSTRAINT CK_TEACHER_STATUS CHECK (STATUS IN ('1','0'))
);

-- 7. 课程表
CREATE TABLE TB_COURSE (
    COURSE_ID     INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    COURSE_NO     VARCHAR(20)   NOT NULL,
    COURSE_NAME   VARCHAR(100)  NOT NULL,
    COURSE_TYPE   VARCHAR(20),
    CREDIT        NUMERIC(4,1),
    PERIOD        INT,
    DEPT_ID       INT           NOT NULL,
    TEA_ID        INT           NOT NULL,
    TERM          VARCHAR(20)   NOT NULL,
    CAPACITY      INT           NOT NULL,
    SELECTED_NUM  INT           NOT NULL DEFAULT 0,
    COURSE_DESC   VARCHAR(500),
    DAY_OF_WEEK   SMALLINT,
    START_SLOT    SMALLINT,
    END_SLOT      SMALLINT,
    LOCATION      VARCHAR(100),
    STATUS        CHAR(1)       NOT NULL DEFAULT '1',
    CONSTRAINT UQ_COURSE_NO_TERM UNIQUE (COURSE_NO, TERM),
    CONSTRAINT FK_COURSE_DEPT FOREIGN KEY (DEPT_ID) REFERENCES TB_DEPARTMENT(DEPT_ID),
    CONSTRAINT FK_COURSE_TEA FOREIGN KEY (TEA_ID) REFERENCES TB_TEACHER(TEA_ID),
    CONSTRAINT CK_COURSE_STATUS CHECK (STATUS IN ('1','0')),
    CONSTRAINT CK_COURSE_CAPACITY CHECK (CAPACITY > 0),
    CONSTRAINT CK_COURSE_SELECTED CHECK (SELECTED_NUM >= 0 AND SELECTED_NUM <= CAPACITY),
    CONSTRAINT CK_COURSE_SLOT CHECK (
        (DAY_OF_WEEK IS NULL AND START_SLOT IS NULL AND END_SLOT IS NULL)
        OR (DAY_OF_WEEK BETWEEN 1 AND 7 AND START_SLOT BETWEEN 1 AND 14 AND END_SLOT BETWEEN START_SLOT AND 14)
    )
);

-- 8. 选课记录表
CREATE TABLE TB_STUDENT_COURSE (
    SC_ID        INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    STU_ID       INT          NOT NULL,
    COURSE_ID    INT          NOT NULL,
    TERM         VARCHAR(20)  NOT NULL,
    SELECT_TIME  TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    DROP_TIME    TIMESTAMP,
    STATUS       CHAR(1)      NOT NULL DEFAULT '1',
    GRADE        NUMERIC(5,2),
    CONSTRAINT UQ_SC UNIQUE (STU_ID, COURSE_ID, TERM),
    CONSTRAINT FK_SC_STUDENT FOREIGN KEY (STU_ID) REFERENCES TB_STUDENT(STU_ID),
    CONSTRAINT FK_SC_COURSE FOREIGN KEY (COURSE_ID) REFERENCES TB_COURSE(COURSE_ID),
    CONSTRAINT CK_SC_STATUS CHECK (STATUS IN ('1','0')),
    CONSTRAINT CK_SC_GRADE CHECK (GRADE IS NULL OR (GRADE >= 0 AND GRADE <= 100))
);

-- 9. 课程时间表（用于课表与冲突检测）
CREATE TABLE TB_COURSE_TIME (
    TIME_ID     INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    COURSE_ID   INT          NOT NULL,
    TERM        VARCHAR(20)  NOT NULL,
    DAY_OF_WEEK SMALLINT     NOT NULL,
    START_SLOT  SMALLINT     NOT NULL,
    END_SLOT    SMALLINT     NOT NULL,
    LOCATION    VARCHAR(100),
    CONSTRAINT FK_TIME_COURSE FOREIGN KEY (COURSE_ID) REFERENCES TB_COURSE(COURSE_ID),
    CONSTRAINT CK_TIME_DAY CHECK (DAY_OF_WEEK BETWEEN 1 AND 7),
    CONSTRAINT CK_TIME_SLOT CHECK (START_SLOT BETWEEN 1 AND 14 AND END_SLOT BETWEEN START_SLOT AND 14),
    CONSTRAINT UQ_TIME_COURSE UNIQUE (COURSE_ID, TERM, DAY_OF_WEEK, START_SLOT, END_SLOT)
);

-- 10. 候补队列表
CREATE TABLE TB_WAITLIST (
    WL_ID       INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    STU_ID      INT          NOT NULL,
    COURSE_ID   INT          NOT NULL,
    TERM        VARCHAR(20)  NOT NULL,
    STATUS      VARCHAR(20)  NOT NULL DEFAULT 'PENDING', -- PENDING/CONFIRMED/FAILED/CANCELLED
    MESSAGE     VARCHAR(200),
    CREATED_AT  TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PROCESSED_AT TIMESTAMP,
    CONSTRAINT FK_WL_STUDENT FOREIGN KEY (STU_ID) REFERENCES TB_STUDENT(STU_ID),
    CONSTRAINT FK_WL_COURSE FOREIGN KEY (COURSE_ID) REFERENCES TB_COURSE(COURSE_ID),
    CONSTRAINT CK_WL_STATUS CHECK (STATUS IN ('PENDING','CONFIRMED','FAILED','CANCELLED')),
    CONSTRAINT UQ_WL UNIQUE (STU_ID, COURSE_ID, TERM)
);

-- 11. 系统参数表
CREATE TABLE TB_SYS_PARAM (
    PARAM_KEY      VARCHAR(50)  PRIMARY KEY,
    PARAM_VALUE    VARCHAR(200),
    PARAM_VALUE_TS TIMESTAMP,
    REMARK         VARCHAR(200),
    CONSTRAINT CK_SYS_PARAM_VALUE CHECK (
        (PARAM_KEY IN ('SELECT_START_TIME','SELECT_END_TIME','DROP_END_TIME') AND PARAM_VALUE_TS IS NOT NULL)
        OR (PARAM_KEY NOT IN ('SELECT_START_TIME','SELECT_END_TIME','DROP_END_TIME') AND PARAM_VALUE IS NOT NULL)
    )
);

-- 12. 索引（高频查询字段）
CREATE INDEX IDX_STUDENT_NO ON TB_STUDENT(STU_NO);
CREATE INDEX IDX_STUDENT_NAME ON TB_STUDENT(STU_NAME);
CREATE INDEX IDX_TEACHER_NO ON TB_TEACHER(TEA_NO);
CREATE INDEX IDX_TEACHER_NAME ON TB_TEACHER(TEA_NAME);
CREATE INDEX IDX_COURSE_NO ON TB_COURSE(COURSE_NO);
CREATE INDEX IDX_COURSE_NAME ON TB_COURSE(COURSE_NAME);
CREATE INDEX IDX_COURSE_TERM ON TB_COURSE(TERM);
CREATE INDEX IDX_SC_STU ON TB_STUDENT_COURSE(STU_ID);
CREATE INDEX IDX_SC_COURSE ON TB_STUDENT_COURSE(COURSE_ID);
CREATE INDEX IDX_SC_TERM ON TB_STUDENT_COURSE(TERM);
CREATE INDEX IDX_TIME_COURSE ON TB_COURSE_TIME(COURSE_ID, TERM);
CREATE INDEX IDX_TIME_DAY ON TB_COURSE_TIME(TERM, DAY_OF_WEEK);
CREATE INDEX IDX_WL_STATUS ON TB_WAITLIST(STATUS, COURSE_ID, TERM);
CREATE INDEX IDX_WL_STU ON TB_WAITLIST(STU_ID, TERM);
