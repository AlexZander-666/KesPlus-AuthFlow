# 高校选课管理系统设计报告（提交包占位稿）

> 版本：2025-12-23（自动生成占位稿，需补充 KesPlus 页面截图与最终排版 PDF）

## 1. 系统概述
- 角色：管理员、教师、学生。
- 特色：选课/退课存储过程、容量触发器、时间冲突检测、候补队列自动补位、统计图表（TopN/学院分布/趋势）、CSV 导出。

## 2. 页面与交互
- Web 静态页：`index.html` 登录；`student.html`（可选课、我的选课、课表、候补队列、冲突提示）；`teacher.html`；`admin.html`；`vue-dashboard.html`（统计大屏，含 CSV 导出按钮）。
- 待补：KesPlus 平台 8+ 页面与菜单（学生/教师/管理员/统计/参数/自定义 Vue 组件等），导出到 `deliverables/kesplus_export/` 并截图。

## 3. 数据库设计与新增对象
- 表：TB_USER、TB_STUDENT、TB_TEACHER、TB_COURSE、TB_STUDENT_COURSE、TB_DEPARTMENT、TB_MAJOR、TB_SYS_PARAM（基线）。
- 新增：TB_COURSE_TIME（课表/冲突检测时间片）、TB_WAITLIST（候补队列）。
- 过程/函数（主要）：
  - 交易：`PROC_SELECT_COURSE`、`PROC_DROP_COURSE`、包装 `FN_SELECT_COURSE`、`FN_DROP_COURSE`。
  - 时间冲突与课表：`FN_CHECK_TIME_CONFLICT`、`FN_STUDENT_TIMETABLE`。
  - 候补：`PROC_JOIN_WAITLIST`、`PROC_PROCESS_WAITLIST`、`FN_JOIN_WAITLIST`、`FN_PROCESS_WAITLIST`、`FN_WAITLIST_BY_STUDENT`。
  - 统计：`PROC_STAT_COURSE_SELECT`、`FN_STAT_COURSE_TOPN`、`FN_STAT_DEPT_DISTRIBUTION`、`FN_STAT_SELECT_TREND`。
- 触发器：维护课程容量与成绩校验（见 `db/02_triggers_course_selection.sql`）。
- 种子数据：`db/04_seed_data_course_selection.sql` 覆盖时间片/候补表清空及示例数据。

## 4. 后端接口（Express）
- 选课链路：`/api/select`、`/api/drop`（鉴权+存储过程调用）。
- 统计：`/api/stat`、`/api/stat/top`、`/api/stat/dept`、`/api/stat/trend`、`/api/export/stat`（CSV 导出）。
- 时间/候补：`/api/courses/conflict`、`/api/courses/timetable`、`/api/waitlist/join`、`/api/waitlist/my`、`/api/waitlist/process`。
- 配置：`/api/config/term`。

## 5. 前端实现要点
- `student.html`：选课前调用冲突检测，课程满员时提示加入候补；展示课表（基于 `FN_STUDENT_TIMETABLE`）与候补列表；退课后自动刷新候补/课表。
- `vue-dashboard.html`：Vue3+ECharts，展示 TopN/学院分布/趋势，支持 CSV 导出。
- `teacher.html` / `admin.html`：保持原有查询与统计入口（可对接 KesPlus 数据源）。

## 6. 测试记录（本地 PostgreSQL 17.6, 端口 54321）
执行顺序：
```powershell
$env:PGPASSWORD='123456'
psql -h localhost -p 54321 -U system -d course_selection_db -f db/01_schema_course_selection.sql
psql -h localhost -p 54321 -U system -d course_selection_db -f db/02_triggers_course_selection.sql
psql -h localhost -p 54321 -U system -d course_selection_db -f db/03_procedures_course_selection.sql
psql -h localhost -p 54321 -U system -d course_selection_db -f db/04_seed_data_course_selection.sql
psql -h localhost -p 54321 -U system -d course_selection_db -f tests/db_trigger_procedure_tests.sql
```
摘要结果：
- 登录/密码：L1~L6 通过（哈希/重置/登录）。
- 触发器：T1~T3 通过（人数自增/自减/删除回收）。
- 选课过程：P1 正常选课通过；P2 满员报错“course full; you may join waitlist”；P3 时间冲突提示；P4 学生失效拦截；P5 默认学期通过。
- 退课：D1/D1b 成功并保留时间戳；D2 超时拦截。
- 统计：S1/S2 返回 9 门课程。
- 冲突/候补：新增 C1、W1~W5 流程通过（冲突检测命中课程1；候补加入→空位后自动补选成功，状态 CONFIRMED）。
- 测试脚本整体 ROLLBACK，数据未持久化。

## 7. 待补充与验收建议
- KesPlus 平台：创建并导出 8+ 页面/菜单/数据源，含角色权限与自定义 Vue 组件，导出包放入 `deliverables/kesplus_export/`，提供菜单与页面截图。
- 报告：将本占位稿完善为正式 PDF，补充 ER 图、页面截图、统计图表截图、KesPlus 导出时间戳、部署与验收步骤。
- 截图清单建议：学生（选课/退课/冲突提示/课表/候补）、教师（课程/学生名单/统计）、管理员（CRUD/参数/统计导出）、数据库对象（表/索引/触发器/过程/函数列表）、测试执行结果。
